<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Prism VSCode-Like Theme -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" />
<link rel="icon" type="image/x-icon" href="templates/imghead.ico">

<!-- Prism Core (must load before any language) -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>

<link rel="stylesheet" href="templates/style.css">


  <title>Παρουσίαση RC Project </title>
  
</head>

<body>
  <header>
    <div></div>
    <nav>
  <a href="index.html">EN</a>
  <a href="index-el.html">GR</a> |
</nav>

    <nav>
      <a href="index-el.html">Αρχική</a>
      <a href="#">Σχετικά</a>
      <a href="#">Portfolio</a>
      <a href="https://www.instagram.com/stratakosmc/?hl=el">Επικοινωνία</a>
    </nav>
  </header>

  <div class="main">
    <h1>Τηλεκατευθυνόμενο online αυτοκίνητο</h1>
<p>Αυτό το project παρουσιάζει την επικοινωνία και τη ροή ισχύος μέσα σε ένα ηλεκτροκίνητο τηλεκατευθυνόμενο χρησιμοποιώντας μικροελεγκτή ESP32</p>  </div>

 
  <div class="gallery">
  <div class="image-box"><img src="templates/car.jpg" alt=""/></div>
  <div class="image-box"><img src="templates/blueprint.PNG" alt=""/></div>
  <div class="image-box"><img src="templates/dashboard.png" alt=""/></div>
  <div class="image-box"><img src="templates/img.JPEG" alt=""/></div>
</div>

  <section style="width: 100%; max-width: 1000px; padding: 40px 20px; box-sizing: border-box;">
    <div style="display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 40px;">
      <img src="templates/img.JPEG" alt="Device 1" style="width: 100%; max-width: 300px; margin-right: 40px; flex-shrink: 0; border: 1px solid #ddd;" />
      <div style="flex: 1; min-width: 200px;">
        <h2 style="margin-top: 0;">Εξαρτήματα</h2>
        <ul style="list-style: none; padding-left: 0; font-size: 1.1em;">
          <li>🚗 Αυτοκίνητο τηλεκατευθυνόμενο με κινητήρα χωρίς ψήκτρες & ESC</li>
          <li>🔋 Li-po Μπαταρία</li>
          <li>🟦 ESP32 Μικροελεγκτής</li>
          <li>📱 Κινητό Android</li>
        </ul>
      </div>
    </div>

    <div style="display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 40px;">
      <img src="templates/screen.png" alt="Device 2" style="width: 100%; max-width: 300px; margin-right: 40px; flex-shrink: 0; border: 1px solid #ddd;" />
    <div style="flex: 1; min-width: 200px;">
        <h2 style="margin-top: 0;">Λογισμικό</h2>
        <ul style="list-style: none; padding-left: 0; font-size: 1.1em;">
            <li>🟦 C++ για ESP32</li>
            <li>🐍 Python για επικοινωνία backend</li>
            <li>🌐 Σχεδιασμός frontend HTML/CSS/JS</li>
            <li>🔒 Εφαρμογή Tailscale για απομακρυσμένη πρόσβαση</li>
            <li>📹 Εφαρμογή IP Webcam για streaming</li>
        </ul>
    </div>
    </div>

  <!-- Component Boxes -->
  <div class="diagram-box" style="top: 20px; left: 340px;">
    <h4> Τυπικό Αναλογικό Σερβο</h4>
    <img src="templates/servo.png" alt="Servo">
  </div>

  <div class="diagram-box" style="top: 300px; left: 30px;">
    <h4>ESP32 μικροελεγκτής</h4>
    <img src="templates/esp.png" alt="ESP32">
  </div>

  <div class="diagram-box" style="top: 300px; left: 340px;">
    <h4>Xiaomi κινητό</h4>
    <img src="templates/android.png" alt="Phone">
  </div>

  <div class="diagram-box" style="top: 20px; left: 630px;">
    <h4>ESC & Κινητήρας</h4>
    <img src="templates/esc.png" alt="Motor">
  </div>

  <div class="diagram-box" style="top: 300px; left: 630px;">
    <h4>Li-Po Μπαταρία</h4>
    <img src="templates/battery.png" alt="Battery">
  </div>

  <!-- SVG Arrows with Text Labels -->
  <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0; pointer-events: none;">
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="orange" />
      </marker>
    </defs>

<section class="steps-section">
  <h2 class="steps-title">Πως ταιριάζουν όλα</h2>

  <div class="step" onclick="toggleStep(this)">
    <div class="step-header">
      <div class="step-number">1</div>
      <div class="step-content">
        <h3>ESP32</h3>
        <p>Ένα καλώδιο τύπου USB C χρησιμοποιείται για τη σύνδεση του ESP32 στη συσκευή Android. Η συσκευή υποστηρίζει σύνδεση Wifi
και είναι συνδεδεμένη στο δίκτυο κινητής τηλεφωνίας (δεδομένα μέσω hotspot). Η C++ για Arduino χρησιμοποιείται για τον προγραμματισμό του μικροελεγκτή ESP32.<br>
Το ESP32 λαμβάνει εντολές και ελέγχει το τιμόνι (Servo) και τον ηλεκτρονικό ελεγκτή ταχύτητας (ESC).</p>
      </div>
    </div>
    <div class="step-drawer">
           <div class="slide drawer-content">
            <pre><code class="language-cpp">
#include &lt;WiFi.h&gt;
#include &lt;PubSubClient.h&gt;
#include &lt;ESP32Servo.h&gt;
#include &lt;ArduinoJson.h&gt;

// your home-hotspot or any Internet-connected Wi-Fi
const char* SSID     = "Redmi10s";
const char* PASS     = "12345678";

// public broker
const char* MQTT_BROKER = "broker.hivemq.com";
const int   MQTT_PORT   = 1883;
const char* TOPIC_INPUT = "myrc/car1/input";

WiFiClient    net;
PubSubClient  mqtt(net);

// pins
const int STEERING_PIN = 18;
const int ESC_PIN      = 19;

// servos
Servo steeringServo, esc;

// state
int steeringAngle = 90;
int throttlePWM   = 0;

// parse incoming MQTT JSON
void onMqttMessage(char* topic, byte* payload, unsigned int len) {
  // copy into a String
  String msg;
  for(int i = 0; i &lt; len; i++) msg += (char)payload[i];

  // expected: {"angle":…, "pwm":…, "gear":…}
  StaticJsonDocument&lt;200&gt; doc;
  DeserializationError err = deserializeJson(doc, msg);
  if(err) {
    Serial.println("❌ JSON parse failed");
    return;
  }
  steeringAngle = doc["angle"];
  throttlePWM   = doc["pwm"];
  Serial.printf("📥 MQTT → angle=%d pwm=%d\n", steeringAngle, throttlePWM);
}

void setup() {
  Serial.begin(115200);
  WiFi.begin(SSID, PASS);
  while(WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n✅ Wi-Fi up, IP=" + WiFi.localIP().toString());

  mqtt.setServer(MQTT_BROKER, MQTT_PORT);
  mqtt.setCallback(onMqttMessage);
  while(!mqtt.connected()) {
    Serial.print("⏳ MQTT connecting…");
    if(mqtt.connect("ESP32RCCar")) {
      Serial.println("✅");
    } else {
      Serial.print(" failed, rc=");
      Serial.print(mqtt.state());
      Serial.println(" retrying in 2s");
      delay(2000);
    }
  }
  mqtt.subscribe(TOPIC_INPUT);
  Serial.println("🔴 Subscribed to " + String(TOPIC_INPUT));

  // attach servos/ESC
  steeringServo.setPeriodHertz(50);
  esc.setPeriodHertz(50);
  steeringServo.attach(STEERING_PIN, 500, 2500);
  esc.attach(ESC_PIN, 1000, 2000);

  // arm ESC
  esc.writeMicroseconds(2000); delay(500);
  esc.writeMicroseconds(1000); delay(500);
  esc.writeMicroseconds(1500); delay(500);
}

void loop() {
  mqtt.loop();  // pump incoming MQTT

  // drive
  steeringServo.write(steeringAngle);
  int us = map(throttlePWM, -255, 255, 1000, 2000);
  esc.writeMicroseconds(constrain(us, 1000, 2000));
}
</code></pre></div>
        </div>
        
      </div>
    </div>
  </div>

  <div class="step" onclick="toggleStep(this)">
    <div class="step-header">
      <div class="step-number">2</div>
      <div class="step-content">
        <h3>Εφαρμογές Κινητού </h3>
     <p>Η εφαρμογή IP Webcam χρησιμοποιείται για τη λήψη βίντεο σε πραγματικό χρόνο και τη μετάδοση στην ιστοσελίδα του πίνακα ελέγχου. <br>
Η εφαρμογή Tailscale χρησιμοποιείται στον υπολογιστή και στο κινητό, δημιουργώντας μια ασφαλή σύνδεση VPN</p>
      </div>
    </div>
    <div class="step-drawer">
      <div class="carousel">
        <div class="slides">
          <div class="slide" style="background-image: url('templates/ipcam.png');">IP webcam Λογότυπο εφαρμογής</div>
          <div class="slide" style="background-image: url('templates/tailscale.png');">Tailscale  Λογότυπο εφαρμογής</div>
          <div class="slide" style="background-image: url('templates/cam.png');">Τοποθέτηση τηλεφώνου στην αεροτομή και ζωντανή μετάδοση από την κάμερα.</div>
        

        </div>
        <div class="dots">
          <span onclick="goToSlide(this, 0)" class="dot active"></span>
          <span onclick="goToSlide(this, 1)" class="dot"></span>
           <span onclick="goToSlide(this, 2)" class="dot"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="step" onclick="openDrawer(this)">
  <div class="step-header">
    <div class="step-number">3</div>
    <div class="step-content">
      <h3>Αρχικοποίηση ελέγχου</h3>
<p>Η εφαρμογή (framework) Python Flask παρέχει μια διεπαφή ελέγχου σε πραγματικό χρόνο στο τηλεκατευθυνόμενο αυτοκίνητο χρησιμοποιώντας ένα χειριστήριο PS4 🎮 και ένα κινητό Android ως κάμερα και ως διακομιστή.</p>
</div>
  </div>
  <div class="step-drawer">
    <div class="carousel">
        <div class="slides">
    <pre><code class="language-python">
import os
import time
import json
import eventlet
eventlet.monkey_patch()

from flask import render_template

from flask import Flask, render_template, Response
from flask_socketio import SocketIO
import paho.mqtt.client as mqtt
import cv2    # ← new

# — Flask / Socket.IO setup —
app = Flask(__name__)
app.config['SECRET_KEY'] = 'rc-car-secret'
socketio = SocketIO(
    app,
    async_mode='eventlet',
    cors_allowed_origins="*",
    logger=True,
    engineio_logger=True
)

@app.route('/phone')
def phone():
    # renders the phone broadcaster template
    return render_template('phone_loc.html')

# — MQTT setup (unchanged) —
MQTT_BROKER = os.getenv('MQTT_BROKER', 'broker.hivemq.com')
MQTT_PORT   = int(os.getenv('MQTT_PORT', '1883'))
TOPIC_INPUT = 'myrc/car1/input'
mqttc = mqtt.Client()
mqttc.connect(MQTT_BROKER, MQTT_PORT, keepalive=60)
mqttc.loop_start()

# — Gear & smoothing (unchanged) —
GEAR_SCALE      = [0.0, 0.10, 0.3, 0.5, 0.7, 1.0]
SMOOTH          = 0.2
steer_smooth    = 0.0
throttle_smooth = 0.0
scale_smooth    = GEAR_SCALE[1]

# — Camera capture setup —  
# 0 = default webcam. Change to RTSP/MJPEG URL for IP cams or "http://<phone>:8080/video"
camera = cv2.VideoCapture("http://100.83.193.15:8080/video") 
if not camera.isOpened():
    raise RuntimeError("Could not start camera.")

def gen_frames():
    """Yield camera frames as multipart MJPEG."""
    while True:
        success, frame = camera.read()
        if not success:
            break
        # optionally: resize, flip, overlay etc here
        ret, buffer = cv2.imencode('.jpg', frame)
        jpg = buffer.tobytes()
        yield (b'--frame\r\n'
               b'Content-Type: image/jpeg\r\n\r\n' + jpg + b'\r\n')

@app.route('/video_feed')
def video_feed():
    return Response(
        gen_frames(),
        mimetype='multipart/x-mixed-replace; boundary=frame'
    )

@app.route('/')
def index():
    # index.html will embed /video_feed
    return render_template('index.html')


@socketio.on('connect')
def handle_connect(auth):
    print(f"[{time.strftime('%H:%M:%S')}] Dashboard connected")
    socketio.emit('telemetry', {
        'steering': 90,
        'throttle': 0,
        'gear': 1,
        'speed': 0.0
    })
@socketio.on('location')
def handle_location(data):
    # data == {'lat':…, 'lng':…}
    print(f"[{time.strftime('%H:%M:%S')}] 📍 got location:", data)
    socketio.emit('location', data)


@socketio.on('controller_input')
def handle_input(data):
    global steer_smooth, throttle_smooth, scale_smooth

    # (your existing smoothing, MQTT publish, telemetry emit…)

    raw_steer = data.get('steering', 0.0)
    raw_thr   = data.get('throttle', 0.0)
    raw_brk   = data.get('brake', 0.0)
    gear      = data.get('gear', 1)

    steer_smooth += SMOOTH * (raw_steer - steer_smooth)
    angle = int((steer_smooth * 0.5 + 0.5) * 180)

    forward = -raw_brk if raw_brk > 0.1 else raw_thr
    throttle_smooth += SMOOTH * (forward - throttle_smooth)

    target_scale = GEAR_SCALE[gear]
    scale_smooth += SMOOTH * (target_scale - scale_smooth)

    pwm = int(throttle_smooth * scale_smooth * 255)

    payload = {'angle': angle,'pwm': pwm,'gear': gear}
    mqttc.publish(TOPIC_INPUT, json.dumps(payload), qos=0)

    speed = abs(pwm) * 0.2 * gear
    socketio.emit('telemetry', {
        'steering': angle,
        'throttle': pwm,
        'gear': gear,
        'speed': round(speed,1)
    })
@socketio.on('restart_esp')
def restart_esp():
    # your code to reset ESP (e.g. serial command or MQTT)
    print("ESP restart requested")

@socketio.on('restart_hotspot')
def restart_hotspot():
    # your code to cycle the Android hotspot
    print("Hotspot restart requested")

if __name__ == '__main__':
    print("Starting server on http://0.0.0.0:5000/")
    socketio.run(app, host='0.0.0.0', port=5000, debug=True)

    </code></pre>
  </div>
</div>
</div>
</div>
<div class="step" onclick="toggleStep(this)">
    <div class="step-header">
      <div class="step-number">4</div>
      <div class="step-content">
        <h3>Ενεργοποίηση RC</h3>
        <p>Ξεκινάμε το broadcasting μέσω της εφαρμογής IP Webcam. Το κινητό έχει τοποθετηθεί στην αεροτομή και είναι συνδεδεμένο με το ESP32. Εφόσον όλα είναι έτοιμα, ανοίγουμε το τηλεκατευθυνόμενο. Τρέχουμε στο Visual Studio τα scripts <code>app.py</code> και <code>ps4controller.py</code> και στη συνέχεια μπαίνουμε στη σελίδα του dashboard.</p>
      </div>
    </div>
    <div class="step-drawer">
      <div class="carousel">
        <div class="slides">
          <div class="slide" style="background-image: url('templates/dashboard.png');"></div>
          <div class="slide" style="background-image: url('templates/blueprint.PNG');"></div>
        </div>
        <div class="dots">
          <span onclick="goToSlide(this, 0)" class="dot active"></span>
          <span onclick="goToSlide(this, 1)" class="dot"></span>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function toggleStep(step) {
step.classList.add("open");
  }

  function goToSlide(dot, index) {
    const dots = dot.parentElement.querySelectorAll('.dot');
    const carousel = dot.closest('.carousel');
    const slides = carousel.querySelector('.slides');

    slides.style.transform = `translateX(-${index * 100}%)`;

    dots.forEach(d => d.classList.remove('active'));
    dot.classList.add('active');
  }
</script>
<script>
  function openDrawer(stepElement) {
    stepElement.classList.add("open");
  }
</script>



<!-- Add this before </body> -->
<div id="img-modal" class="img-modal" style="display:none;">
  <span class="close" onclick="closeModal()">&times;</span>
  <img class="img-modal-content" id="modal-img">
</div>

<script>
  // Open modal when image is clicked
  document.querySelectorAll('.image-box img').forEach(img => {
    img.style.cursor = "pointer";
    img.onclick = function() {
      document.getElementById('img-modal').style.display = "block";
      document.getElementById('modal-img').src = this.src;
      document.getElementById('modal-img').alt = this.alt;
    }
  });

  // Close modal
  function closeModal() {
    document.getElementById('img-modal').style.display = "none";
  }

  // Optional: close modal when clicking outside the image
  document.getElementById('img-modal').onclick = function(e) {
    if (e.target === this) closeModal();
  }
</script>
     <p>
      Created with ❤️ by <a href="https://www.instagram.com/stratakosmc/?hl=el" target="_blank" style="color:#1DA1F2; text-decoration:none;">@stratakosmc</a><br>
      Source code on <a href="https://github.com/sasimis/rconlinecar" target="_blank" style="color:#6cc644; text-decoration:none;">GitHub</a>
    </p>
</body>
</html>
